<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notion Event Sync</title>
    <!-- Load Tailwind CSS from CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <!-- Load React, ReactDOM, and Babel -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-gray-50 font-sans">
    <div id="root">
        <!-- React component will render here -->
        <div class="flex justify-center items-center h-screen text-xl text-gray-400">Loading Application...</div>
    </div>

    <script type="text/babel">
        // --- IMPORTANT: CONFIGURE YOUR API ENDPOINTS AND IDs HERE ---
        // 1. LIVE PROXY URL (The Vercel domain where your API is deployed)
        const NOTION_PROXY_URL = "https://vercel-repository-henna.vercel.app/api/notion-event-creator"; 

        // 2. The Gemini API key will be provided by the Canvas environment at runtime.
        const apiKey = ""; 
        const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

        // Helper to convert File to Base64
        const toBase64 = file => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result.split(',')[1]);
            reader.onerror = error => reject(error);
        });

        // Helper to handle exponential backoff for API calls
        const fetchWithRetry = async (url, options, retries = 3) => {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.ok) {
                        return response;
                    }
                    if (response.status >= 400 && response.status < 500) {
                        if (response.status !== 429) throw new Error(`HTTP Error: ${response.status} - ${await response.text()}`);
                    }
                    
                    throw new Error(`Non-critical HTTP Error: ${response.status}`);
                    
                } catch (error) {
                    if (i < retries - 1) {
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                        console.warn(`Retrying after ${delay.toFixed(0)}ms: ${error.message}`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                    } else {
                        throw error; 
                    }
                }
            }
        };


        // Main Application Component
        const App = () => {
            const { useState, useEffect } = React;
            const [selectedFile, setSelectedFile] = useState(null);
            const [extractedEvents, setExtractedEvents] = useState([]);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);
            const [statusMessage, setStatusMessage] = useState('');

            // Step 1: Handle File Selection
            const handleFileChange = (event) => {
                const file = event.target.files[0];
                if (file && file.type.startsWith('image/')) {
                    setSelectedFile(file);
                    setError(null);
                } else {
                    setSelectedFile(null);
                    setError('Please select a valid image file.');
                }
            };

            // Step 2: Use Gemini to Analyze the Image and Extract JSON Data
            const handleAnalyze = async () => {
                if (!selectedFile) {
                    setError('Please select an image file first.');
                    return;
                }

                setLoading(true);
                setError(null);
                setExtractedEvents([]);
                setStatusMessage('1/3: Analyzing image and extracting events...');

                try {
                    const base64Image = await toBase64(selectedFile);

                    const systemPrompt = `You are a calendar and event extraction specialist. Your task is to analyze the image of a schedule or calendar and extract all events into a structured JSON array. Each event MUST have four fields: "subject" (a concise string title), "date" (formatted as YYYY-MM-DD), "location" (a string location or venue name), and "description" (a string summarizing the event's content or notes). Only output the JSON array, nothing else.`;
                    const userQuery = "Extract all schedule events from this image and format the output as a JSON array of objects. Ensure dates are in YYYY-MM-DD format.";

                    const payload = {
                        contents: [{
                            parts: [
                                { text: userQuery },
                                {
                                    inlineData: {
                                        mimeType: selectedFile.type,
                                        data: base64Image
                                    }
                                }
                            ]
                        }],
                        systemInstruction: {
                            parts: [{ text: systemPrompt }]
                        },
                        generationConfig: {
                            responseMimeType: "application/json",
                            responseSchema: {
                                type: "ARRAY",
                                items: {
                                    type: "OBJECT",
                                    properties: {
                                        "subject": { "type": "STRING" },
                                        "date": { "type": "STRING" },
                                        "location": { "type": "STRING" },
                                        "description": { "type": "STRING" }
                                    },
                                    propertyOrdering: ["subject", "date", "location", "description"]
                                }
                            }
                        }
                    };

                    const response = await fetchWithRetry(GEMINI_API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    const result = await response.json();
                    const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    
                    if (!jsonText) {
                        throw new Error("Gemini returned no valid JSON content.");
                    }

                    const events = JSON.parse(jsonText);
                    setExtractedEvents(events);
                    setStatusMessage(`2/3: Successfully extracted ${events.length} events. Now creating pages in Notion...`);

                    await handleNotionCreation(events);

                } catch (err) {
                    console.error('Gemini Analysis Error:', err);
                    setError(`Failed to analyze image: ${err.message}`);
                    setLoading(false);
                    setStatusMessage('');
                }
            };

            // Step 3: Send Extracted Data to Notion API
            const handleNotionCreation = async (events) => {
                if (!events || events.length === 0) {
                    setStatusMessage('2/3: No events extracted to send to Notion.');
                    setLoading(false);
                    return;
                }
                
                let createdCount = 0;
                let failedCount = 0;

                for (const event of events) {
                    setStatusMessage(`3/3: Processing event: "${event.subject}"...`);
                    try {
                        const response = await fetchWithRetry(NOTION_PROXY_URL, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(event)
                        });

                        if (response.ok) {
                            createdCount++;
                        } else {
                            failedCount++;
                            console.error(`Failed to create Notion page for: ${event.subject}`, await response.text());
                        }
                    } catch (err) {
                        failedCount++;
                        console.error(`Error sending event to Notion API for: ${event.subject}`, err);
                    }
                }
                
                setLoading(false);
                if (failedCount === 0) {
                    setStatusMessage(`✅ Success! Created ${createdCount} pages in Notion.`);
                } else {
                    setStatusMessage(`⚠️ Completed with errors. Created ${createdCount} pages, but ${failedCount} failed. Check console for details.`);
                }
            };


            return (
                <div className="min-h-screen bg-gray-50 flex flex-col items-center p-4 sm:p-8 font-sans">
                    <div className="w-full max-w-4xl bg-white shadow-xl rounded-xl p-6 sm:p-10">
                        <header className="mb-8 text-center">
                            <h1 className="text-4xl font-extrabold text-indigo-700 mb-2">
                                Event Sync with Notion
                            </h1>
                            <p className="text-gray-500">
                                Upload an image of a schedule to automatically extract events and create Notion database pages.
                            </p>
                        </header>

                        {/* File Uploader and Action Button */}
                        <div className="border border-dashed border-gray-300 rounded-lg p-6 bg-gray-50 mb-8 flex flex-col sm:flex-row items-center justify-between">
                            <div className="flex items-center space-x-4 mb-4 sm:mb-0">
                                <label 
                                    htmlFor="file-upload" 
                                    className={`cursor-pointer inline-flex items-center px-4 py-2 border border-gray-300 rounded-lg shadow-sm text-sm font-medium transition duration-150 ease-in-out ${
                                        selectedFile ? 'bg-indigo-50 text-indigo-700 hover:bg-indigo-100' : 'bg-white text-gray-700 hover:bg-gray-50'
                                    }`}
                                >
                                    <svg className="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                                    {selectedFile ? 'Change Image' : 'Select Image File'}
                                </label>
                                <input 
                                    id="file-upload" 
                                    type="file" 
                                    accept="image/*" 
                                    onChange={handleFileChange} 
                                    className="sr-only" 
                                />
                                {selectedFile && (
                                    <span className="text-sm text-gray-600 truncate max-w-[200px]">
                                        {selectedFile.name}
                                    </span>
                                )}
                            </div>
                            
                            <button
                                onClick={handleAnalyze}
                                disabled={!selectedFile || loading}
                                className={`px-6 py-3 rounded-lg text-white font-semibold transition duration-200 ease-in-out shadow-lg 
                                    ${!selectedFile || loading ? 'bg-gray-400 cursor-not-allowed' : 'bg-indigo-600 hover:bg-indigo-700 active:bg-indigo-800'}`}
                            >
                                {loading ? (
                                    <svg className="animate-spin -ml-1 mr-3 h-5 w-5 text-white inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                        <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                        <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg>
                                ) : 'Analyze & Sync to Notion'}
                            </button>
                        </div>

                        {/* Status and Error Messages */}
                        {(statusMessage || error) && (
                            <div className={`mb-8 p-4 rounded-lg text-center font-medium shadow-md ${error ? 'bg-red-100 text-red-700' : 'bg-blue-100 text-blue-700'}`}>
                                {error ? `Error: ${error}` : statusMessage}
                            </div>
                        )}

                        {/* Extracted Events Table */}
                        {extractedEvents.length > 0 && (
                            <div className="mt-8">
                                <h2 className="text-2xl font-bold text-gray-800 mb-4">
                                    Extracted Events Preview ({extractedEvents.length})
                                </h2>
                                <div className="overflow-x-auto rounded-lg shadow-md">
                                    <table className="min-w-full divide-y divide-gray-200">
                                        <thead className="bg-indigo-50">
                                            <tr>
                                                <th className="px-4 py-3 text-left text-xs font-semibold text-indigo-700 uppercase tracking-wider">
                                                    Subject
                                                </th>
                                                <th className="px-4 py-3 text-left text-xs font-semibold text-indigo-700 uppercase tracking-wider">
                                                    Date
                                                </th>
                                                <th className="px-4 py-3 text-left text-xs font-semibold text-indigo-700 uppercase tracking-wider hidden sm:table-cell">
                                                    Location
                                                </th>
                                            </tr>
                                        </thead>
                                        <tbody className="bg-white divide-y divide-gray-200">
                                            {extractedEvents.map((event, index) => (
                                                <tr key={index} className="hover:bg-gray-50">
                                                    <td className="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900 truncate max-w-[150px]">
                                                        {event.subject}
                                                    </td>
                                                    <td className="px-4 py-3 whitespace-nowrap text-sm text-gray-500">
                                                        {event.date}
                                                    </td>
                                                    <td className="px-4 py-3 whitespace-nowrap text-sm text-gray-500 hidden sm:table-cell">
                                                        {event.location}
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                                <p className="mt-4 text-sm text-gray-500">
                                    These events have been sent to your Notion API endpoint (`{NOTION_PROXY_URL}`).
                                </p>
                            </div>
                        )}

                    </div>
                </div>
            );
        };

        // Render the component
        ReactDOM.render(<App />, document.getElementById('root'));

    </script>
</body>
</html>
